#pragma once

#include "devices/IDevice.h"
#include "devices/WS2812.h"

#include <cstdint>
#include <vector>
#include <memory>
#include <string>

class SevenSeg : public IDevice, public IDeviceUser, public std::enable_shared_from_this<SevenSeg> {
public:
  SevenSeg(std::shared_ptr<WS2812> led, const std::string& name = "7Seg");

  const std::string getName() const override { return _name; }
  const std::string getType() const override { return "7Seg"; }
  const std::string getDetails() const override;

  /// Set the value to display on the 7-segment display
  /// The value should be a string of 5 characters, each character can be:
  /// - '0' to '9' for digits - 'A' to 'F' for letters A-F
  /// - '-' for dash ' ' for blank
  /// The format is 2 digits then a dot, double dot or blank, then 2 more digits. For example:
  /// "12.34" will display "12.34"
  /// "12.3-" will display "12.3-"
  /// "12:34" will display "12:34"
  /// "12 34" will display "12 34"
  /// Returns true if the value was set successfully, false if the value was invalid or if the device is not ready
  void setValue(const std::string& value);
  void setColor(uint32_t color){
    _color = color;
  }

  std::shared_ptr<SevenSeg> getShared() {
      return shared_from_this();
  }

private:
  // 7-segment display lookup table: maps ASCII characters to segment codes
  // Segment layout:  BBB
  //                 A   C
  //                  DDD
  //                 E   G
  //                  FFF
  // Stored in flash memory
  static constexpr uint8_t ASCII_TO_7SEG[128] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 0x00-0x07
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 0x08-0x0F
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 0x10-0x17
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 0x18-0x1F
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 0x20-0x27 (space = 0x00)
    0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, // 0x28-0x2F (dash '-' = 0x08)
    0x77, 0x11, 0x3E, 0x3B, 0x19, 0x6B, 0x6F, 0x31, // 0x30-0x37 ('0'-'7')
    0x7F, 0x7B, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 0x38-0x3F ('8'-'9')
    0x00, 0x7D, 0x0E, 0x66, 0x5E, 0x6E, 0x6C, 0x13, // 0x40-0x47 ('A'-'G')
    0x1D, 0x11, 0x17, 0x00, 0x46, 0x00, 0x00, 0x77, // 0x48-0x4F ('H'-'O')
    0x7C, 0x00, 0x00, 0x6B, 0x00, 0x47, 0x00, 0x00, // 0x50-0x57 ('P'-'S', 'U')
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 0x58-0x5F
    0x7D, 0x0E, 0x66, 0x5E, 0x6E, 0x6C, 0x13, 0x1D, // 0x60-0x67 ('a'-'g')
    0x11, 0x17, 0x00, 0x46, 0x00, 0x00, 0x77, 0x7C, // 0x68-0x6F ('h'-'o')
    0x00, 0x00, 0x6B, 0x00, 0x47, 0x00, 0x00, 0x00, // 0x70-0x77 ('p'-'s', 'u')
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 0x78-0x7F
  };

  std::shared_ptr<WS2812> _led;
  std::string _name;
  uint32_t _color;

  uint32_t _ledString[142]; // 4 digits * 7 segments * 5 leds per segment + 2 dot leds = 142 LEDs total

  uint32_t* setCharacter(uint32_t* ledData, char c);
};